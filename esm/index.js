var kt=Object.defineProperty;var vt=(e,t)=>{for(var n in t)kt(e,n,{get:t[n],enumerable:!0})};var r={timeout:5e3,stepDelay:100,fetchDelay:0,maskTime:0,keepSameKey:!1,minLogDelay:250,testReStartKey:"",testAgainKey:"",enable:void 0,onError:(e,t)=>{},onBeforeEach:e=>{},onTagChange:(e,t)=>{},selects:[],push:e=>(location.href=e,new Promise(t=>setTimeout(t,100))),e2e:()=>{}};var H;function E(e){let t=document.getElementById("testing-label");t||(t=document.createElement("div"),t.id="testing-label",t.style.pointerEvents="none",t.style.transition=`all ${r.stepDelay<50?50:r.stepDelay*.7}ms ease`,t.style.background="rgba(0,0,0,0.5)",t.style.color="#f33",t.style.height="auto",t.style.borderRadius="6px",t.style.zIndex="99999",t.style.position="fixed",t.style.padding="4px 8px",t.style.right="0px",t.style.bottom="0px",t.style.whiteSpace="nowrap",t.style.transformOrigin="center",document.body.append(t)),t.textContent=e,t.style.opacity="1",H&&clearTimeout(H),H=setTimeout(()=>{t.style.opacity="0"},5e3)}function St(e,t){if(t<1)return e;let n=e;return async function(...o){let i=n(...o).finally(()=>{});return t>=r.minLogDelay&&E("Fetch delay: "+t+"ms"),await new Promise(s=>setTimeout(s,t)),i}}function Z(e){window.fetch=St(window.fetch,e)}var _=0;function Lt(e,t){let n=e;return async function(...o){return t&&t(...o)?n(...o):(_+=1,n(...o).finally(()=>{_-=1}))}}var tt=!1;function et(){tt||(tt=!0,window.fetch=Lt(window.fetch,e=>/\.(svg|jpg|png|gif)/.test(e)))}function nt(){return _>0}var rt="Test all",P="TEST",q="Step delay",G="Fetch delay",K="Test again",j="!! Quit testing mode",b="testing",S="testing-state",y="testing-state-result";var k={};vt(k,{cleanTasks:()=>d,getDoing:()=>L,getFetchDelay:()=>w,getStepTime:()=>N,isDone:()=>$,setDoing:()=>h,setDone:()=>F,setFetchDelay:()=>U,setStepTime:()=>z,storageGet:()=>u,storageRemove:()=>l,storageSet:()=>c});var O="testing-history";function l(e){typeof window>"u"||sessionStorage.removeItem(e)}function u(e){if(typeof window>"u")return;let t=sessionStorage.getItem(e);if(!!t)try{return JSON.parse(t).j}catch{return}}function c(e,t){typeof window>"u"||sessionStorage.setItem(e,JSON.stringify({j:t}))}function A(){let e=u(O);return e||(e={}),e}function $(e){let t=A();return t[t.doing+e]==="done"}function F(e){let t=A();t[t.doing+e]="done",c(O,t)}function h(e){let t=A();t.doing=e,c(O,t)}function L(){return A().doing}function d(){l(y),c(O,{})}function z(e){c("stepTime",e)}function N(){let e=u("stepTime");return e!==0&&!e?null:e}function U(e){c("fetchDelay",e)}function w(){let e=u("fetchDelay");return e!==0&&!e?null:e}var ot=!1;function it(){if(typeof window>"u"||r.testAgainKey===""&&r.testReStartKey===""||ot)return;ot=!0;let e=t=>{if(!t.ctrlKey&&!t.metaKey)return!0;if(t.key===r.testReStartKey){t.preventDefault(),t.stopPropagation();let n=L();return d(),h(n),r.e2e(),!1}return t.key===r.testAgainKey&&(t.preventDefault(),t.stopPropagation(),r.e2e()),!1};window.addEventListener("keydown",e)}import Dt from"crypto-es";var st=e=>Dt.MD5(e).toString();async function f(e=17){e<=0||(typeof requestIdleCallback>"u"||typeof requestAnimationFrame>"u"?await new Promise(t=>{setTimeout(()=>{t(void 0)},20)}):await new Promise(t=>requestAnimationFrame(t)),await new Promise(t=>{setTimeout(()=>{t(void 0)},e)}))}function V(e,t=""){return typeof e=="string"?e:e==null?t:String(e)}var Bt=[P,q,G,K],It=[j];function at(e){e.innerHTML="";let t=document.createElement("select");t.value="TEST",t.name="testing-select",Object.assign(t.style,{appearance:"none",boxShadow:"none",border:"none",borderRadius:"0px",outline:"none",background:"rgba(0,0,0,0)",color:"#fff",padding:"0px",fontSize:"14px",position:"absolute",left:0,top:0,width:"100px",opacity:"0"}),Object.assign(e.style,{right:"0",top:"0",position:"fixed",zIndex:"9999",width:"100px",height:"20px",background:"#f33",opacity:"0.6",cursor:"pointer",transformOrigin:"left",display:"flex",justifyContent:"center",alignItems:"center",transform:"rotate(45deg) translate(11px, -50px)"});let n=document.createElement("div");Object.assign(n.style,{width:"100px",height:"100%",textAlign:"center",PointerEvent:"none",color:"#fff",marginTop:"3px",fontSize:"14px",fontWeight:"700"}),n.textContent="TEST",e.appendChild(n),e.append(t),[...Bt,...r.selects,...r.enable===void 0?It:[]].forEach(i=>{let s=document.createElement("option");s.value=i,s.textContent=i,t.append(s)}),t.onchange=i=>{let s=i.target.value;if(t.value=P,s===q){let a=Number(prompt("Please input step time(ms):",V(w(),"0")));if(isNaN(a))return;z(a);return}if(s===G){let a=Number(prompt("Please input step time(ms):",V(w(),"0")));if(isNaN(a))return;U(a);return}if(s===j){d(),l(b),location.reload();return}if(s===P){d(),l(S);return}if(s===K){let a=L();d(),h(a),r.e2e();return}r.onTagChange(s,k)}}function ct(){let e=document.getElementById("renderTestingTag");if(e){at(e);return}let t=document.createElement("div");t.id="renderTestingTag",at(t),document.body.appendChild(t)}var lt=!1;function ut(){if(typeof window<"u"&&!lt){lt=!0;let e,t=0,n="http://";window.addEventListener("touchend",o=>{if(o.touches.length===1){if(t+=1,t>3)if(n=prompt(`\u5F53\u524D:${location.href}`,n)||"",n==="http://log"){let i=document.createElement("script");i.src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js",i.onload=()=>{new window.VConsole},document.head.append(i)}else n!=="http://"&&(location.href=n);e&&clearTimeout(e),e=setTimeout(()=>{t=0},2e3)}})}}function mt(){return typeof window>"u"||(ut(),/testing=remove/.test(location.href)&&(l("testing"),d()),!/testing=1/.test(location.href)&&u("testing")!=="1")?!1:(c("testing","1"),ct(),!0)}var Y,J;async function p(){return Y||(Y=await import("@testing-library/dom")),Y}async function ft(){return J||(J=(await import("@testing-library/user-event")).default),J}var x=async(e,t=3e3,n=0,o="Not found element")=>{if(n>t/100)throw new Error(o);let i=await e();return i||(await f(100),nt()?x(e,t,n,o):x(e,t,n+1,o))},Q=async(e,t=3e3)=>x(async()=>{let n;return document.querySelectorAll("input, textarea").forEach(o=>{o.value===e&&(n=o)}),n},t,0,"Not found input element value is: "+e),v=async(e,t=3e3)=>x(async()=>(await p()).screen.queryByRole(e),t,0,"Not found role element: "+e),D=async(e,t=3e3)=>x(async()=>(await p()).screen.queryByTestId(e,{}),t),M=async(e,t=3e3)=>x(async()=>(await p()).screen.queryByText(e,{trim:!0}),t,0,"Not found text element: "+e),R=async(e,t=3e3)=>x(async()=>(await p()).screen.queryByLabelText(e,{trim:!0,selector:"*"}),t,0,"Not found label text element: "+e),pt=async(e,t,n=3e3)=>{let o=await v(e,n);return(await p()).fireEvent.change(o,{target:{value:t}}),o},yt=async(e,t=3e3)=>{let n=await v(e,t);return(await p()).fireEvent.click(n),n},dt=async(e,t,n=3e3)=>{let o=await D(e,n);return(await p()).fireEvent.change(o,{target:{value:t}}),o},gt=async(e,t=3e3)=>{let n=await D(e,t);return(await p()).fireEvent.click(n),n};function Pt(e){if(typeof window>"u"||!e)return{left:0,top:0,width:0,height:0,fixedTop:0,fixedLeft:0};let t=e.getBoundingClientRect(),n={top:0,left:0},o=e;for(;o;)n.left+=o.offsetLeft,n.top+=o.offsetTop,o=o.offsetParent;return{left:t.left,top:t.top,width:t.width,height:t.height,fixedTop:n.top+document.documentElement.scrollTop,fixedLeft:n.left+document.documentElement.scrollLeft}}var C=0;function Tt(e){let t=document.getElementById("testing-mask");t||(t=document.createElement("div"),t.id="testing-mask",t.style.pointerEvents="none",t.style.transition=`all ${r.stepDelay<100?100:r.stepDelay*.7}ms ease`,t.style.background="rgba(255,100,100,0.3)",t.style.border="1px solid rgba(128,128,128,0.3)",t.style.width="30px",t.style.height="30px",t.style.borderRadius="6px",t.style.zIndex="99999",t.style.position="fixed",t.style.transformOrigin="center",document.body.append(t)),C+=1,C>99&&(C=0);let n=Pt(e);Object.assign(t.style,{opacity:"1",transform:`rotate(${C*720}deg)`,left:n.fixedLeft+n.width/2-15+"px",top:n.fixedTop+n.height/2-15+"px"})}function Et(){let e=document.getElementById("testing-mask");e&&(e.style.opacity="0")}var ht=!1;typeof window<"u"&&window.addEventListener("load",()=>{ht=!0});async function wt(){ht||setTimeout(()=>{wt()},50)}async function g(e,{beforeWait:t,afterWait:n,key:o},i){await T.it(e+(o||""),async()=>{t&&(t>=r.minLogDelay&&E("Before waiting: "+t+"ms, "+e),await f(t));let s=await i();s&&Tt(s),n&&(n>=r.minLogDelay&&E("After waiting: "+n+"ms, "+e),await f(n))})}var B={},T={queryByLabelText:R,queryByRole:v,queryByTestId:D,queryByText:M,queryInputValue:Q,it:async function(e,t){let n=e;r.keepSameKey&&(B[e]||(B[e]=0),B[e]+=1,n=e+" "+B[e],$(n))||(await wt(),F(e+B),r.stepDelay>=r.minLogDelay&&E("Step delay: "+r.stepDelay+"ms"),await f(r.stepDelay),E(n),await f(20),await Promise.resolve(t()),F(n))},async push(e,t={}){return g(e,t,async()=>{await f(100),await r.push(e),await f(100)})},async wait(e,t){return T.it("[wait]"+e,async()=>{await new Promise(n=>setTimeout(n,t))})},async findByRole(e,{timeout:t=r.timeout,...n}={}){return g(e.trim(),n,async()=>v(e,t))},async findByText(e,{timeout:t=r.timeout,...n}={}){return g(e.trim(),n,async()=>M(e,t))},async findByLabelText(e,{timeout:t=r.timeout,...n}={}){return g(e.trim(),n,async()=>R(e,t))},async findByInputValue(e,{timeout:t=r.timeout,...n}={}){return g(e.trim(),n,()=>Q(e,t))},async clickByRole(e,{timeout:t=r.timeout,...n}={}){return g(e,n,async()=>yt(e,t))},async changeByRole(e,t,{timeout:n=r.timeout,...o}={}){return g(e,o,()=>pt(e,t,n))},async clickByTestId(e,{timeout:t=r.timeout,...n}={}){return g(e,n,()=>gt(e,t))},async changeByTestId(e,t,{timeout:n=r.timeout,...o}={}){return g("[changeByTestId] "+e,o,()=>dt(e,t,n))},not:async function(e,t,n=10){let o=0,i=async()=>{if(o>n)throw new Error("always find by: "+e);o+=1;try{return await f(100),await t(),i()}catch(s){if(!s.message)throw s;let a=s.message.split(`
`)[0];if(/Found multiple elements/.test(a))return i()}};return i()},notFindByRole:async function(e,t=300){return T.not(e,async()=>{await v(e,t)})},notFindByTestId:async function(e,t=300){return T.not(e,async()=>{await D(e,t)})},notFindByText:async function(e,t=300){return T.not(e,async()=>{await M(e,t)})},notFindByLabelText:async function(e,t=300){return T.not(e,async()=>{await R(e,t)})}};var W;async function xt(){if(!W){let e=await p(),t=await ft(),n=(await import("@faker-js/faker")).faker;W={testingLibrary:e,userEvent:t,faker:n,candy:T,md5:st}}return W}var X=async(e,t)=>{let n="";if(!mt())return;let o=await xt();if(!!e){it(),et(),r.stepDelay=N()!==null?N():r.stepDelay,r.fetchDelay=w()!==null?w():r.stepDelay,Z(r.fetchDelay);try{if(Array.isArray(t))for(let i of t)n=e+"/"+i.id,h(n),await i.test(o,n),r.onBeforeEach(n)}catch(i){let s=Error(i.toString().split(`
`)[0],{cause:i});console.error(s),r.onError&&r.onError(s,n)}}};function Ot({onError:e,onSuccess:t,onBeforeEach:n,tests:o,enable:i=!0}){r.e2e=()=>{r.enable=i,i!==void 0&&(i?c(b,"1"):l(b)),n&&(r.onBeforeEach=n),r.onError=(a,m)=>{c(y,"fail"),e?.(a,m)},r.onTagChange=(a,m)=>{m.cleanTasks(),l(y),c(S,a),r.e2e()};let s={...o};Object.values(o).forEach((a,m)=>{a.forEach((I,bt)=>{r.keepSameKey?I.id=`${I.name} [${m+1}/${bt+1}]`:I.id=I.name})}),s[rt]=Object.values(s).flat(),r.selects=Object.keys(s),(async()=>{let a=u(S)||"";if(X("",[]),!u(y)){for(let m of r.selects){if(u(y)==="fail")break;a===m&&await X(m,s[m])}setTimeout(()=>{u(y)||(t?.(a),c(y,"success")),Et()},100)}})()},r.e2e()}Ot.unEnable=()=>{l(b)};export{Z as bindFetchDelay,St as bindPromiseDelay,Lt as bindWaitByEvent,et as bindWaitByFech,Ot as createTesting,nt as isFetching,mt as isNeedTesting,X as onTesting,r as testingOptions};
