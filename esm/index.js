var bt=Object.defineProperty;var kt=(e,t)=>{for(var n in t)bt(e,n,{get:t[n],enumerable:!0})};var r={timeout:5e3,stepDelay:100,fetchDelay:0,maskTime:0,keepSameKey:!1,testReStartKey:"",testAgainKey:"",enable:void 0,onError:(e,t)=>{},onBeforeEach:e=>{},onTagChange:(e,t)=>{},selects:[],push:e=>(location.href=e,new Promise(t=>setTimeout(t,100))),e2e:()=>{}};var H;function E(e){let t=document.getElementById("testing-label");t||(t=document.createElement("div"),t.id="testing-label",t.style.pointerEvents="none",t.style.transition=`all ${r.stepDelay<50?50:r.stepDelay*.7}ms ease`,t.style.background="rgba(0,0,0,0.5)",t.style.color="#f33",t.style.height="auto",t.style.borderRadius="6px",t.style.zIndex="99999",t.style.position="fixed",t.style.padding="4px 8px",t.style.right="0px",t.style.bottom="0px",t.style.whiteSpace="nowrap",t.style.transformOrigin="center",document.body.append(t)),t.textContent=e,t.style.opacity="1",H&&clearTimeout(H),H=setTimeout(()=>{t.style.opacity="0"},5e3)}function vt(e,t){if(t<1)return e;let n=e;return async function(...o){let i=n(...o).finally(()=>{});return E("Fetch delay: "+t+"ms"),await new Promise(s=>setTimeout(s,t)),i}}function X(e){window.fetch=vt(window.fetch,e)}var _=0;function St(e,t){let n=e;return async function(...o){return t&&t(...o)?n(...o):(_+=1,n(...o).finally(()=>{_-=1}))}}var Z=!1;function tt(){Z||(Z=!0,window.fetch=St(window.fetch,e=>/\.(svg|jpg|png|gif)/.test(e)))}function et(){return _>0}var nt="Test all",I="TEST",q="Step delay",G="Fetch delay",K="Test again",j="!! Quit testing mode",x="testing",v="testing-state",y="testing-state-result";var b={};kt(b,{cleanTasks:()=>d,getDoing:()=>S,getFetchDelay:()=>F,getStepTime:()=>N,isDone:()=>$,setDoing:()=>w,setDone:()=>O,setFetchDelay:()=>U,setStepTime:()=>z,storageGet:()=>u,storageRemove:()=>l,storageSet:()=>c});var P="testing-history";function l(e){typeof window>"u"||sessionStorage.removeItem(e)}function u(e){if(typeof window>"u")return;let t=sessionStorage.getItem(e);if(!!t)try{return JSON.parse(t).j}catch{return}}function c(e,t){typeof window>"u"||sessionStorage.setItem(e,JSON.stringify({j:t}))}function A(){let e=u(P);return e||(e={}),e}function $(e){let t=A();return t[t.doing+e]==="done"}function O(e){let t=A();t[t.doing+e]="done",c(P,t)}function w(e){let t=A();t.doing=e,c(P,t)}function S(){return A().doing}function d(){l(y),c(P,{})}function z(e){c("stepTime",e)}function N(){let e=u("stepTime");return e!==0&&!e?null:e}function U(e){c("fetchDelay",e)}function F(){let e=u("fetchDelay");return e!==0&&!e?null:e}var rt=!1;function ot(){if(typeof window>"u"||r.testAgainKey===""&&r.testReStartKey===""||rt)return;rt=!0;let e=t=>{if(!t.ctrlKey&&!t.metaKey)return!0;if(t.key===r.testReStartKey){t.preventDefault(),t.stopPropagation();let n=S();return d(),w(n),r.e2e(),!1}return t.key===r.testAgainKey&&(t.preventDefault(),t.stopPropagation(),r.e2e()),!1};window.addEventListener("keydown",e)}var Lt=[I,q,G,K],Dt=[j];function it(e){e.innerHTML="";let t=document.createElement("select");t.value="TEST",t.name="testing-select",Object.assign(t.style,{appearance:"none",boxShadow:"none",border:"none",borderRadius:"0px",outline:"none",background:"rgba(0,0,0,0)",color:"#fff",padding:"0px",fontSize:"14px",position:"absolute",left:0,top:0,width:"100px",opacity:"0"}),Object.assign(e.style,{right:"0",top:"0",position:"fixed",zIndex:"9999",width:"100px",height:"20px",background:"#f33",opacity:"0.6",cursor:"pointer",transformOrigin:"left",display:"flex",justifyContent:"center",alignItems:"center",transform:"rotate(45deg) translate(11px, -50px)"});let n=document.createElement("div");Object.assign(n.style,{width:"100px",height:"100%",textAlign:"center",PointerEvent:"none",color:"#fff",marginTop:"3px",fontSize:"14px",fontWeight:"700"}),n.textContent="TEST",e.appendChild(n),e.append(t),[...Lt,...r.selects,...r.enable===void 0?Dt:[]].forEach(i=>{let s=document.createElement("option");s.value=i,s.textContent=i,t.append(s)}),t.onchange=i=>{let s=i.target.value;if(t.value=I,s===q){let a=Number(prompt("Please input step time(ms):"));if(isNaN(a))return;z(a);return}if(s===G){let a=Number(prompt("Please input step time(ms):"));if(isNaN(a))return;U(a);return}if(s===j){d(),l(x),location.reload();return}if(s===I){d(),l(v);return}if(s===K){let a=S();d(),w(a),r.e2e();return}r.onTagChange(s,b)}}function st(){let e=document.getElementById("renderTestingTag");if(e){it(e);return}let t=document.createElement("div");t.id="renderTestingTag",it(t),document.body.appendChild(t)}var at=!1;function ct(){if(typeof window<"u"&&!at){at=!0;let e,t=0,n="http://";window.addEventListener("touchend",o=>{if(o.touches.length===1){if(t+=1,t>3)if(n=prompt(`\u5F53\u524D:${location.href}`,n)||"",n==="http://log"){let i=document.createElement("script");i.src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js",i.onload=()=>{new window.VConsole},document.head.append(i)}else n!=="http://"&&(location.href=n);e&&clearTimeout(e),e=setTimeout(()=>{t=0},2e3)}})}}function lt(){return typeof window>"u"||(ct(),/testing=remove/.test(location.href)&&(l("testing"),d()),!/testing=1/.test(location.href)&&u("testing")!=="1")?!1:(c("testing","1"),st(),!0)}import Bt from"crypto-es";var ut=e=>Bt.MD5(e).toString();async function m(e=17){e<=0||(typeof requestIdleCallback>"u"||typeof requestAnimationFrame>"u"?await new Promise(t=>{setTimeout(()=>{t(void 0)},20)}):await new Promise(t=>requestAnimationFrame(t)),await new Promise(t=>{setTimeout(()=>{t(void 0)},e)}))}var V,Y;async function p(){return V||(V=await import("@testing-library/dom")),V}async function ft(){return Y||(Y=(await import("@testing-library/user-event")).default),Y}var h=async(e,t=3e3,n=0,o="Not found element")=>{if(n>t/100)throw new Error(o);let i=await e();return i||(await m(100),et()?h(e,t,n,o):h(e,t,n+1,o))},J=async(e,t=3e3)=>h(async()=>{let n;return document.querySelectorAll("input, textarea").forEach(o=>{o.value===e&&(n=o)}),n},t,0,"Not found input element value is: "+e),k=async(e,t=3e3)=>h(async()=>(await p()).screen.queryByRole(e),t,0,"Not found role element: "+e),L=async(e,t=3e3)=>h(async()=>(await p()).screen.queryByTestId(e,{}),t),M=async(e,t=3e3)=>h(async()=>(await p()).screen.queryByText(e,{trim:!0}),t,0,"Not found text element: "+e),R=async(e,t=3e3)=>h(async()=>(await p()).screen.queryByLabelText(e,{trim:!0,selector:"*"}),t,0,"Not found label text element: "+e),mt=async(e,t,n=3e3)=>{let o=await k(e,n);return(await p()).fireEvent.change(o,{target:{value:t}}),o},pt=async(e,t=3e3)=>{let n=await k(e,t);return(await p()).fireEvent.click(n),n},yt=async(e,t,n=3e3)=>{let o=await L(e,n);return(await p()).fireEvent.change(o,{target:{value:t}}),o},dt=async(e,t=3e3)=>{let n=await L(e,t);return(await p()).fireEvent.click(n),n};function It(e){if(typeof window>"u"||!e)return{left:0,top:0,width:0,height:0,fixedTop:0,fixedLeft:0};let t=e.getBoundingClientRect(),n={top:0,left:0},o=e;for(;o;)n.left+=o.offsetLeft,n.top+=o.offsetTop,o=o.offsetParent;return{left:t.left,top:t.top,width:t.width,height:t.height,fixedTop:n.top+document.documentElement.scrollTop,fixedLeft:n.left+document.documentElement.scrollLeft}}var C=0;function gt(e){let t=document.getElementById("testing-mask");t||(t=document.createElement("div"),t.id="testing-mask",t.style.pointerEvents="none",t.style.transition=`all ${r.stepDelay<50?50:r.stepDelay*.7}ms ease`,t.style.background="rgba(255,100,100,0.3)",t.style.border="1px solid rgba(128,128,128,0.3)",t.style.width="30px",t.style.height="30px",t.style.borderRadius="6px",t.style.zIndex="99999",t.style.position="fixed",t.style.transformOrigin="center",document.body.append(t)),C+=1,C>99&&(C=0);let n=It(e);Object.assign(t.style,{opacity:"1",transform:`rotate(${C*720}deg)`,left:n.fixedLeft+n.width/2-15+"px",top:n.fixedTop+n.height/2-15+"px"})}function Tt(){let e=document.getElementById("testing-mask");e&&(e.style.opacity="0")}var Et=!1;typeof window<"u"&&window.addEventListener("load",()=>{Et=!0});async function wt(){Et||setTimeout(()=>{wt()},50)}async function g(e,{beforeWait:t,afterWait:n,key:o},i){await T.it(e+(o||""),async()=>{t&&(E("Before waiting: "+t+"ms, "+e),await m(t));let s=await i();s&&gt(s),n&&(E("After waiting: "+n+"ms, "+e),await m(n))})}var D={},T={queryByLabelText:R,queryByRole:k,queryByTestId:L,queryByText:M,queryInputValue:J,it:async function(e,t){let n=e;r.keepSameKey&&(D[e]||(D[e]=0),D[e]+=1,n=e+" "+D[e],$(n))||(await wt(),O(e+D),E("Step delay: "+r.stepDelay+"ms"),await m(r.stepDelay),E(n),await m(20),await Promise.resolve(t()),O(n))},async push(e,t={}){return g(e,t,async()=>{await m(100),await r.push(e),await m(100)})},async wait(e,t){return T.it("[wait]"+e,async()=>{await new Promise(n=>setTimeout(n,t))})},async findByRole(e,{timeout:t=r.timeout,...n}={}){return g(e.trim(),n,async()=>k(e,t))},async findByText(e,{timeout:t=r.timeout,...n}={}){return g(e.trim(),n,async()=>M(e,t))},async findByLabelText(e,{timeout:t=r.timeout,...n}={}){return g(e.trim(),n,async()=>R(e,t))},async findByInputValue(e,{timeout:t=r.timeout,...n}={}){return g(e.trim(),n,()=>J(e,t))},async clickByRole(e,{timeout:t=r.timeout,...n}={}){return g(e,n,async()=>pt(e,t))},async changeByRole(e,t,{timeout:n=r.timeout,...o}={}){return g(e,o,()=>mt(e,t,n))},async clickByTestId(e,{timeout:t=r.timeout,...n}={}){return g(e,n,()=>dt(e,t))},async changeByTestId(e,t,{timeout:n=r.timeout,...o}={}){return g("[changeByTestId] "+e,o,()=>yt(e,t,n))},not:async function(e,t,n=10){let o=0,i=async()=>{if(o>n)throw new Error("always find by: "+e);o+=1;try{return await m(100),await t(),i()}catch(s){if(!s.message)throw s;let a=s.message.split(`
`)[0];if(/Found multiple elements/.test(a))return i()}};return i()},notFindByRole:async function(e,t=300){return T.not(e,async()=>{await k(e,t)})},notFindByTestId:async function(e,t=300){return T.not(e,async()=>{await L(e,t)})},notFindByText:async function(e,t=300){return T.not(e,async()=>{await M(e,t)})},notFindByLabelText:async function(e,t=300){return T.not(e,async()=>{await R(e,t)})}};var Q;async function ht(){if(!Q){let e=await p(),t=await ft(),n=(await import("@faker-js/faker")).faker;Q={testingLibrary:e,userEvent:t,faker:n,candy:T,md5:ut}}return Q}var W=async(e,t)=>{let n="";if(!lt())return;let o=await ht();if(!!e){ot(),tt(),r.stepDelay=N()!==null?N():r.stepDelay,r.fetchDelay=F()!==null?F():r.stepDelay,X(r.fetchDelay);try{if(Array.isArray(t))for(let i of t)n=e+"/"+i.id,w(n),await i.test(o,n),r.onBeforeEach(n)}catch(i){let s=Error(i.toString().split(`
`)[0],{cause:i});console.error(s),r.onError&&r.onError(s,n)}}};function Pt({onError:e,onSuccess:t,onBeforeEach:n,tests:o,enable:i=!0}){r.e2e=()=>{r.enable=i,i!==void 0&&(i?c(x,"1"):l(x)),n&&(r.onBeforeEach=n),r.onError=(a,f)=>{c(y,"fail"),e?.(a,f)},r.onTagChange=(a,f)=>{f.cleanTasks(),l(y),c(v,a),r.e2e()};let s={...o};Object.values(o).forEach((a,f)=>{a.forEach((B,xt)=>{r.keepSameKey?B.id=`${B.name} [${f+1}/${xt+1}]`:B.id=B.name})}),s[nt]=Object.values(s).flat(),r.selects=Object.keys(s),(async()=>{let a=u(v)||"";if(W("",[]),!u(y)){for(let f of r.selects){if(u(y)==="fail")break;a===f&&await W(f,s[f])}setTimeout(()=>{u(y)||(t?.(a),c(y,"success")),Tt()},100)}})()},r.e2e()}Pt.unEnable=()=>{l(x)};export{X as bindFetchDelay,vt as bindPromiseDelay,St as bindWaitByEvent,tt as bindWaitByFech,Pt as createTesting,et as isFetching,lt as isNeedTesting,W as onTesting,r as testingOptions};
